### 1. Попередня підготовка

За допомогою packer необхідно підготовити образи для інстансів проекту.

Образ для додатку включає в себе попереднє встановлення докеру за допомогою
[ansible плейбуку](/course_project/ansible/ami_app.yml)
```
packer build -var-file=variables.pkr.hcl app.pkr.hcl
```

Образ для бд включає в себе попереднє розгортання та налаштування бази за допогою
[ansible плейбуку в якому використовується стороння роль](/course_project/ansible/ami_db.yml)
```
packer build -var-file=variables.pkr.hcl db.pkr.hcl
```

### 2. Хмарні налаштування

#### 2.1 Налаштування мережі
В директорії /terraform/vpc/ за допомогою стороннього модулю розгортається мережа з віддаленим бекендом.

```
terraform apply -auto-approve
```

#### 2.2 Запуск хмарної інфраструктури
В директорії /terraform/ виконуємо розгортання хмарної інфраструктури (наразі код тільки для dev оточення).

На основі бекенду мережі створеної в попередньому кроці створюється:
- сек'юріті групи на основі локального модулю
- два інстанси для проекту та бд на основі готових образів створених packer
- генерується inventory файл для подальшого налаштування інстансу з проектом
- генерується .env файл для проекту (містить змінні для підключення до бд)
- для ci/cd на гітлабі записуються необхідні змінні

```
terraform apply -auto-approve
```

#### 2.3 Налаштування існтансу з проектом
В директорії /ansible необхідно запустити плейбук на основі згенерованого inventory файлу.

Основні дії плейбуку:
- налаштувати проект
- запустити гітлаб раннер

```
ansible-playbook -i inventory setting_app.yml
```

### 3. CI/CD

Проект знаходиться у [gitlab репозиторії](https://gitlab.com/group4883448/course-project).

** Були розшиті місця доступу до бд у коді, тепер доступи до бд тягнуться через змінні оточення. Це дає змогу
підключатися до контейнера з бд на локалі або до віддаленого хосту на деві.

Пайплайн описаний у [.gitlab-ci.yml файлі](https://gitlab.com/group4883448/course-project/-/blob/main/.gitlab-ci.yml).

Пайплайн має три етапи:
- test (запуск лінтерів hadolint та flake8)
- build
  - білд проекту за допомогою файлу docker-compose.yml
  - тегування та запис до Container Registry образів зібраних під час білду
- deploy
  - підключення до хоста за допомогою змінних які були встановленні при розгортанні terraform
    - оновлення кодової бази (для актуальної версії docker-compose.images.yml)
    - перезапуск проекту на основі оновлених образів з попереднього етапу за допомогою
    [docker-compose.images.yml](https://gitlab.com/group4883448/course-project/-/blob/main/docker-compose.images.yml)
